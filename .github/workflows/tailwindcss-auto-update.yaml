name: Auto Update TailwindCSS and Publish NuGet

on:
  schedule:
    # Run every day at 00:00 UTC
    - cron: '0 0 * * *'
  workflow_dispatch:

jobs:
  check-update:
    runs-on: ubuntu-latest
    outputs:
      update_needed: ${{ steps.check_update.outputs.update_needed }}
      tailwindcss_version: ${{ steps.get_tailwind_version.outputs.tailwindcss_version }}
      tailwindcss_version_clean: ${{ steps.get_tailwind_version.outputs.tailwindcss_version_clean }}
      current_tailwind_version: ${{ steps.get_nuget_version.outputs.current_tailwind_version }}
      lib_version: ${{ steps.get_nuget_version.outputs.lib_version }}
      new_lib_version: ${{ steps.check_update.outputs.new_lib_version }}
      new_version: ${{ steps.check_update.outputs.new_version }}

    steps:
      - name: Get latest TailwindCSS version
        id: get_tailwind_version
        run: |
          set -e
          LATEST_TAILWIND_VERSION=$(curl -s https://api.github.com/repos/tailwindlabs/tailwindcss/releases/latest | grep '"tag_name":' | sed -E 's/.*"([^"]+)".*/\1/')
          if [ -z "$LATEST_TAILWIND_VERSION" ]; then
            echo "Error: Failed to fetch latest TailwindCSS version from GitHub API." >&2
            exit 1
          fi
          echo "Latest TailwindCSS version: $LATEST_TAILWIND_VERSION"
          echo "tailwindcss_version=$LATEST_TAILWIND_VERSION" >> $GITHUB_OUTPUT
          echo "tailwindcss_version_clean=${LATEST_TAILWIND_VERSION//v/}" >> $GITHUB_OUTPUT

      - name: Get current version from NuGet
        id: get_nuget_version
        run: |
          set -e
          PACKAGE_NAME="DotnetDevKR.TailwindCSS"

          # Fetch all versions from NuGet API
          NUGET_RESPONSE=$(curl -s "https://api.nuget.org/v3-flatcontainer/${PACKAGE_NAME,,}/index.json")

          if echo "$NUGET_RESPONSE" | grep -q '"versions"'; then
            # Get the latest version from NuGet
            NUGET_VERSION=$(echo "$NUGET_RESPONSE" | grep -oP '"[^"]+\+v[^"]+' | tail -1 | tr -d '"')

            if [ -z "$NUGET_VERSION" ]; then
              echo "No version with TailwindCSS metadata found in NuGet. Using default."
              NUGET_VERSION="0.0.0+v0.0.0"
            fi

            echo "Latest NuGet version: $NUGET_VERSION"

            # Extract library version and TailwindCSS version
            LIB_VERSION=$(echo $NUGET_VERSION | cut -d'+' -f1)
            CURRENT_TAILWIND_VERSION=$(echo $NUGET_VERSION | cut -d'+' -f2 | sed 's/v//')

            echo "Current library version: $LIB_VERSION"
            echo "Current TailwindCSS version: $CURRENT_TAILWIND_VERSION"
            echo "lib_version=$LIB_VERSION" >> $GITHUB_OUTPUT
            echo "current_tailwind_version=$CURRENT_TAILWIND_VERSION" >> $GITHUB_OUTPUT
          else
            echo "Package not found on NuGet. This might be the first publish."
            echo "lib_version=0.0.0" >> $GITHUB_OUTPUT
            echo "current_tailwind_version=0.0.0" >> $GITHUB_OUTPUT
          fi

      - name: Check if update is needed
        id: check_update
        run: |
          CURRENT_TAILWIND_VERSION="${{ steps.get_nuget_version.outputs.current_tailwind_version }}"
          TAILWINDCSS_VERSION_CLEAN="${{ steps.get_tailwind_version.outputs.tailwindcss_version_clean }}"
          LIB_VERSION="${{ steps.get_nuget_version.outputs.lib_version }}"

          if [ "$CURRENT_TAILWIND_VERSION" != "$TAILWINDCSS_VERSION_CLEAN" ]; then
            echo "Update needed: $CURRENT_TAILWIND_VERSION -> $TAILWINDCSS_VERSION_CLEAN"
            echo "update_needed=true" >> $GITHUB_OUTPUT

            # Increment patch version (0.1.0 -> 0.1.1)
            IFS='.' read -ra VERSION_PARTS <<< "$LIB_VERSION"
            MAJOR=${VERSION_PARTS[0]}
            MINOR=${VERSION_PARTS[1]}
            PATCH=${VERSION_PARTS[2]}
            NEW_PATCH=$((PATCH))
            NEW_LIB_VERSION="$MAJOR.$MINOR.$NEW_PATCH"

            echo "New library version: $NEW_LIB_VERSION"
            echo "new_lib_version=$NEW_LIB_VERSION" >> $GITHUB_OUTPUT
            echo "new_version=$NEW_LIB_VERSION+v$TAILWINDCSS_VERSION_CLEAN" >> $GITHUB_OUTPUT
          else
            echo "No update needed. Current version is already up to date."
            echo "update_needed=false" >> $GITHUB_OUTPUT
          fi

  build-and-publish:
    needs: check-update
    if: needs.check-update.outputs.update_needed == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup .NET SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "9.x"

      - name: Update version in csproj
        run: |
          sed -i "s|<Version>.*</Version>|<Version>${{ needs.check-update.outputs.new_version }}</Version>|" ./DotnetDevKR.TailwindCSS/DotnetDevKR.TailwindCSS.csproj
          echo "Updated csproj to version: ${{ needs.check-update.outputs.new_version }}"

      - name: Update version in install.sh
        run: |
          sed -i "s|VERSION=\${1:-\"v[^\"]*\"}|VERSION=\${1:-\"${{ needs.check-update.outputs.tailwindcss_version }}\"}|" ./DotnetDevKR.TailwindCSS/runtime/install.sh
          echo "Updated install.sh to TailwindCSS version: ${{ needs.check-update.outputs.tailwindcss_version }}"

      - name: Download TailwindCSS executables
        run: |
          chmod +x ./DotnetDevKR.TailwindCSS/runtime/install.sh
          ./DotnetDevKR.TailwindCSS/runtime/install.sh ${{ needs.check-update.outputs.tailwindcss_version }}

      - name: Restore dependencies
        run: dotnet restore DotnetDevKR.TailwindCSS.sln

      - name: Build
        run: dotnet build DotnetDevKR.TailwindCSS.sln --configuration Release --no-restore

      - name: Pack
        run: |
          dotnet pack ./DotnetDevKR.TailwindCSS/DotnetDevKR.TailwindCSS.csproj --configuration Release \
            --no-build --no-restore \
            --output ./artifacts \
            /p:Version=${{ needs.check-update.outputs.new_version }}

      - name: Commit and push changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -A
          git commit -m "chore: Update TailwindCSS to ${{ needs.check-update.outputs.tailwindcss_version }} and bump version to ${{ needs.check-update.outputs.new_version }}"
          git tag "v${{ needs.check-update.outputs.new_lib_version }}"
          git push origin ${{ github.ref_name }}
          git push origin "v${{ needs.check-update.outputs.new_lib_version }}"

      - name: Publish to NuGet.org
        run: |
          dotnet nuget push ./artifacts/*.nupkg \
            --source https://api.nuget.org/v3/index.json \
            --api-key ${{ secrets.NUGET_API_KEY }} \
            --skip-duplicate
        env:
          NUGET_API_KEY: ${{ secrets.NUGET_API_KEY }}

      - name: Publish to GitHub Packages
        run: |
          dotnet nuget push ./artifacts/*.nupkg \
            --source https://nuget.pkg.github.com/dotnetdev-kr/index.json \
            --api-key ${{ secrets.GITHUB_TOKEN }} \
            --skip-duplicate
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ needs.check-update.outputs.new_lib_version }}
          name: Release v${{ needs.check-update.outputs.new_lib_version }}
          body: |
            ## Updates
            - Updated TailwindCSS from v${{ needs.check-update.outputs.current_tailwind_version }} to ${{ needs.check-update.outputs.tailwindcss_version }}
            - Package version: ${{ needs.check-update.outputs.new_version }}

            ## Installation
            ```bash
            dotnet add package DotnetDevKR.TailwindCSS --version ${{ needs.check-update.outputs.new_version }}
            ```
          files: ./artifacts/*.nupkg
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
